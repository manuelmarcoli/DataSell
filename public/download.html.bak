<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Download DataSell APK</title>
  <link rel="stylesheet" href="/css/responsive.css">
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:1rem;padding:1rem;color:#0f172a} .card{max-width:720px;margin:1.5rem auto;padding:1rem;border:1px solid #e6eefc;border-radius:8px;background:#fff} .btn{display:inline-block;padding:.6rem 1rem;background:#2563eb;color:#fff;border-radius:6px;text-decoration:none}</style>
</head>
<body>
  <main class="card">
    <h1>Download DataSell</h1>
    <p>Download the APK below and install on your Android device. You may need to allow installs from unknown sources for your browser.</p>
    <p><a id="apkLink" class="btn" href="/downloads/datasell-debug.apk" download>Download APK</a></p>
    <p style="font-size:.9rem;color:#475569">File size: <strong id="apkSize">calculating...</strong></p>
    <p style="font-size:.9rem;color:#475569">SHA-256: <code id="checksum">(calculating...)</code></p>
    <p style="font-size:.9rem;color:#475569"><span id="hashStatus">Hashing may take a few seconds...</span></p>
    <p style="font-size:.9rem;color:#475569">Instructions: After download, open the file to install. On Android 8+ you must allow the browser to install unknown apps (Settings → Apps → [your browser] → Install unknown apps).</p>
  </main>
  <script>
    // Compute APK file size (from HEAD) and SHA-256 checksum in the browser.
    (async function(){
      try {
        const apkPath = '/downloads/datasell-debug.apk';

        // Get size via HEAD
        let sizeText = 'unknown';
        try {
          const head = await fetch(apkPath, { method: 'HEAD' });
          const len = head.headers.get('content-length');
          if (len) {
            const n = Number(len);
            if (!Number.isNaN(n)) {
              const kb = n / 1024;
              if (kb < 1024) sizeText = kb.toFixed(1) + ' KB'; else sizeText = (kb/1024).toFixed(2) + ' MB';
            }
          }
        } catch (e) {
          // ignore head failures
        }
        document.getElementById('apkSize').textContent = sizeText;

        // Hash the file using SubtleCrypto
        const statusEl = document.getElementById('hashStatus');
        statusEl.textContent = 'Downloading for checksum...';

        const resp = await fetch(apkPath);
        if (!resp.ok) throw new Error('Failed to download APK for checksum');
        const ab = await resp.arrayBuffer();

        statusEl.textContent = 'Computing SHA-256...';
        const hashBuffer = await crypto.subtle.digest('SHA-256', ab);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');

        document.getElementById('checksum').textContent = hashHex;
        statusEl.textContent = 'Checksum ready';
      } catch (err) {
        console.error('Checksum error', err);
        document.getElementById('checksum').textContent = '(failed to compute)';
        document.getElementById('hashStatus').textContent = '';
      }
    })();
  </script>
</body>
</html>
